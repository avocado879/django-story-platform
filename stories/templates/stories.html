{% extends 'base.html' %}
{% load static %}

{% block title %}故事库 - 故事会{% endblock %}

{% block extra_css %}
<style>
    /* 主内容容器 */
    .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    /* 筛选栏 */
    .filter-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .filter-select {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        font-size: 1rem;
        color: #6d4c41;
        font-family: inherit;
    }

    /* 搜索框样式 */
    .search-box {
        position: relative;
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        flex: 1;
        max-width: 400px;
    }

    .search-input {
        flex: 1;
        padding: 0.5rem 1rem;
        border: none;
        outline: none;
        font-size: 1rem;
        color: #6d4c41;
        font-family: inherit;
    }

    .search-input::placeholder {
        color: #999;
    }

    .search-btn {
        padding: 0.5rem 1rem;
        background: #8b5a2b;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .search-btn:hover {
        background: #6d4c41;
    }

    .clear-search-btn {
        padding: 0.5rem;
        background: transparent;
        color: #999;
        border: none;
        cursor: pointer;
        transition: color 0.3s;
    }

    .clear-search-btn:hover {
        color: #6d4c41;
    }

    /* 搜索结果样式 */
    .search-results {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f5f2;
        border-radius: 8px;
        border-left: 4px solid #8b5a2b;
    }

    .search-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .clear-results-btn {
        background: transparent;
        color: #8b5a2b;
        border: 1px solid #8b5a2b;
        padding: 0.3rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s;
    }

    .clear-results-btn:hover {
        background: #8b5a2b;
        color: white;
    }

    /* 加载动画 */
    .loading-spinner {
        text-align: center;
        padding: 2rem;
        color: #8b5a2b;
    }

    .loading-spinner i {
        font-size: 2rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* 无结果状态 */
    .no-results {
        text-align: center;
        padding: 3rem;
        color: #888;
    }

    .no-results i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #ddd;
    }

    /* 故事网格布局 */
    .story-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }

    /* 故事卡片*/
    .story-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(109, 76, 65, 0.05);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .story-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(109, 76, 65, 0.1);
    }
    .story-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px 10px 0 0;
    }
    .story-info {
        padding: 1.5rem;
    }
    .story-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
        color: #888;
    }
    .story-category {
        background-color: #8b5a2b10; /* 浅棕背景 */
        color: #8b5a2b; /* 棕色调分类标签 */
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        font-size: 0.7rem;
    }
    .story-title {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        transition: color 0.3s;
        color: #6d4c41;
    }
    .story-card:hover .story-title {
        color: #8b5a2b; /* hover时标题变色 */
    }
    .story-title a {
        text-decoration: none;
        color: inherit;
    }
    .story-excerpt {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: -webkit-box;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .story-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #888;
    }
    .story-stats span {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    /* 空状态提示 */
    .empty-state {
        text-align: center;
        padding: 5rem 0;
        color: #888;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #ddd;
    }
    .empty-state a {
        color: #8b5a2b;
        text-decoration: none;
        font-weight: 500;
    }
    .empty-state a:hover {
        text-decoration: underline;
    }

    /* 统计信息样式 */
    .stats-container {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        flex-wrap: wrap;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        color: #6d4c41;
    }

    .stat-item i {
        color: #8b5a2b;
    }

    /* 响应式适配 */
    @media (max-width: 768px) {
        .story-grid {
            grid-template-columns: 1fr;
        }

        .stats-container {
            flex-direction: column;
            gap: 0.5rem;
        }

        .stat-item {
            justify-content: center;
        }

        .search-box {
            max-width: 100%;
        }

        .filter-container {
            flex-direction: column;
        }
    }

    /* 点赞显示样式 */
    .story-stats span {
        transition: all 0.3s ease;
    }

    .story-stats .fa-heart {
        color: #888;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 筛选栏 -->
    <div class="filter-container">
        <!-- 搜索框 -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索故事标题或分类..." class="search-input">
            <button id="searchBtn" class="search-btn">
                <i class="fa fa-search"></i>
            </button>
            <button id="clearSearch" class="clear-search-btn" style="display: none;">
                <i class="fa fa-times"></i>
            </button>
        </div>

        <select class="filter-select" id="categoryFilter">
            <option value="all">所有分类</option>
            {% for category in categories %}
                <option value="{{ category.name }}" {% if selected_category == category.name %}selected{% endif %}>
                    {{ category.name }}
                </option>
            {% endfor %}
        </select>

        <select class="filter-select" id="sortFilter">
            <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>最新发布</option>
            <option value="popular" {% if sort_by == 'popular' %}selected{% endif %}>最多点赞</option>
        </select>
    </div>

    <!-- 搜索结果指示器 -->
    <div id="searchResults" class="search-results" style="display: none;">
        <div class="search-info">
            <span id="searchResultText"></span>
            <button id="clearSearchResults" class="clear-results-btn">
                <i class="fa fa-times"></i> 清除搜索
            </button>
        </div>
    </div>

    <div class="story-grid" id="storyGrid">
        {% for story in stories %}
            <div class="story-card">
                <div class="story-img-container">
                    <img src="https://picsum.photos/id/{{ story.img_id|default:100 }}/600/400" alt="{{ story.title }}" class="story-img">
                </div>
                <div class="story-info">
                    <div class="story-meta">
                        <span class="story-category">{{ story.category.name }}</span>
                        <span>{{ story.created_at|date:"Y-m-d" }}</span>
                    </div>
                    <h3 class="story-title">
                        <a href="{% url 'stories:story_detail' story.id %}">{{ story.title }}</a>
                    </h3>
                    <p class="story-excerpt">{{ story.content|truncatechars:100 }}</p>
                    <div class="story-stats">
                        <span><i class="fa fa-heart"></i> {{ story.likes }}</span>
                        <span><i class="fa fa-clock-o"></i> {{ story.read_time }} 分钟阅读</span>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="empty-state" id="emptyState">
                <i class="fa fa-book"></i>
                <h3>还没有故事</h3>
                <p>快去<a href="{% url 'stories:generate_story' %}">生成</a>你的第一个奇幻故事吧！</p>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 全局变量
    let likeUpdateInterval;
    let currentStories = [];

    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        const categoryFilter = document.getElementById('categoryFilter');
        const sortFilter = document.getElementById('sortFilter');

        // 存储当前故事数据
        initializeStoriesData();

        function applyFilters() {
            const category = categoryFilter.value;
            const sortBy = sortFilter.value;

            let url = '{% url "stories:stories" %}?';

            if (category !== 'all') {
                url += `category=${category}&`;
            }

            if (sortBy !== 'newest') {
                url += `sort=${sortBy}&`;
            }

            if (url.endsWith('&') || url.endsWith('?')) {
                url = url.slice(0, -1);
            }

            window.location.href = url;
        }

        categoryFilter.addEventListener('change', applyFilters);
        sortFilter.addEventListener('change', applyFilters);

        // 优化故事摘要显示 - 移除HTML标签
        cleanStoryExcerpts();

        // 启动实时点赞数更新
        startLikeUpdates();

        // 初始化搜索功能
        initializeSearch();

        // 显示统计信息
        displayStatistics();
    });

    // 初始化故事数据
    function initializeStoriesData() {
        const storyCards = document.querySelectorAll('.story-card');
        currentStories = Array.from(storyCards).map(card => {
            const storyId = card.querySelector('a').href.split('/').filter(Boolean).pop();
            const likeElement = card.querySelector('.fa-heart').closest('span');
            return {
                id: storyId,
                element: card,
                likeElement: likeElement,
                currentLikes: parseInt(likeElement.textContent) || 0
            };
        });
    }

    // 清理故事摘要中的HTML标签
    function cleanStoryExcerpts() {
        document.querySelectorAll('.story-excerpt').forEach(excerpt => {
            const text = excerpt.textContent;
            // 移除HTML标签并截取纯文本
            const cleanText = text.replace(/<[^>]*>/g, '').trim();
            // 截取前100个字符
            excerpt.textContent = cleanText.length > 100 ?
                cleanText.substring(0, 100) + '...' : cleanText;
        });
    }

    // 启动实时点赞数更新
    function startLikeUpdates() {
        if (currentStories.length === 0) return;

        // 每20秒更新一次所有故事的点赞数
        likeUpdateInterval = setInterval(updateAllStoryLikes, 20000);

        // 立即执行一次更新
        updateAllStoryLikes();

        // 页面可见性变化时控制更新
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(likeUpdateInterval);
            } else {
                clearInterval(likeUpdateInterval);
                likeUpdateInterval = setInterval(updateAllStoryLikes, 20000);
                // 页面重新可见时立即更新
                updateAllStoryLikes();
            }
        });
    }

    // 更新所有故事的点赞数
    function updateAllStoryLikes() {
        const storyIds = currentStories.map(story => story.id);

        fetch(`/stories/get_multiple_story_likes/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                story_ids: storyIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStoriesLikesUI(data.likes_data);
            } else {
                console.error('获取点赞数据失败:', data.message);
            }
        })
        .catch(error => {
            console.error('更新点赞数失败:', error);
        });
    }

    // 更新故事点赞数UI
    function updateStoriesLikesUI(likesData) {
        likesData.forEach(storyData => {
            const story = currentStories.find(s => s.id == storyData.story_id);
            if (story && story.likeElement) {
                const currentLikes = story.currentLikes;
                const newLikes = storyData.likes_count;

                // 只有当数字变化时才更新
                if (currentLikes !== newLikes) {
                    story.likeElement.textContent = newLikes;
                    story.currentLikes = newLikes;

                    // 添加数字变化动画
                    animateLikeCountChange(story.likeElement, currentLikes, newLikes);

                    // 如果按点赞数排序，可能需要重新排序
                    if (document.getElementById('sortFilter').value === 'popular') {
                        // 可以添加重新排序逻辑
                        // sortStoriesByLikes();
                    }
                }
            }
        });
    }

    // 点赞数变化动画
    function animateLikeCountChange(element, oldValue, newValue) {
        // 保存原始颜色
        const originalColor = element.style.color;

        // 添加动画效果
        element.style.transform = 'scale(1.3)';
        element.style.color = '#b71c1c';
        element.style.transition = 'all 0.4s ease';

        setTimeout(() => {
            element.style.transform = 'scale(1)';
            element.style.color = originalColor || '#888';
        }, 400);
    }

    // 搜索功能
    function initializeSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const clearSearch = document.getElementById('clearSearch');
        const clearSearchResults = document.getElementById('clearSearchResults');
        const searchResults = document.getElementById('searchResults');
        const searchResultText = document.getElementById('searchResultText');
        const storyGrid = document.getElementById('storyGrid');
        const emptyState = document.getElementById('emptyState');

        let searchTimeout;

        // 搜索函数
        function performSearch() {
            const query = searchInput.value.trim();

            if (!query) {
                clearSearchResultsHandler();
                return;
            }

            // 显示加载状态
            showLoading();

            // 发送搜索请求
            fetch(`/stories/search/?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySearchResults(data);
                } else {
                    showError(data.message || '搜索失败');
                }
            })
            .catch(error => {
                console.error('搜索错误:', error);
                showError('搜索失败，请重试');
            })
            .finally(() => {
                hideLoading();
            });
        }

        // 显示搜索结果
        function displaySearchResults(data) {
            // 更新搜索结果显示
            searchResultText.textContent = `找到 ${data.count} 个与 "${data.query}" 相关的故事`;
            searchResults.style.display = 'block';

            // 更新故事网格
            if (data.count > 0) {
                renderStories(data.stories);
            } else {
                showNoResults(data.query);
            }

            // 显示清除搜索按钮
            clearSearch.style.display = 'block';
        }

        // 渲染故事列表
        function renderStories(stories) {
            if (emptyState) {
                emptyState.style.display = 'none';
            }

            const storiesHTML = stories.map(story => `
                <div class="story-card">
                    <div class="story-img-container">
                        <img src="https://picsum.photos/id/${story.img_id}/600/400" alt="${story.title}" class="story-img">
                    </div>
                    <div class="story-info">
                        <div class="story-meta">
                            <span class="story-category">${story.category}</span>
                            <span>${story.created_at}</span>
                        </div>
                        <h3 class="story-title">
                            <a href="/stories/story/${story.id}/">${story.title}</a>
                        </h3>
                        <p class="story-excerpt">${story.excerpt}</p>
                        <div class="story-stats">
                            <span><i class="fa fa-heart"></i> ${story.likes}</span>
                            <span><i class="fa fa-clock-o"></i> ${story.read_time} 分钟阅读</span>
                        </div>
                    </div>
                </div>
            `).join('');

            storyGrid.innerHTML = storiesHTML;

            // 重新初始化故事数据
            initializeStoriesData();

            // 清理故事摘要
            cleanStoryExcerpts();
        }

        // 显示无结果状态
        function showNoResults(query) {
            storyGrid.innerHTML = `
                <div class="no-results">
                    <i class="fa fa-search"></i>
                    <h3>没有找到相关故事</h3>
                    <p>没有找到与 "<strong>${query}</strong>" 相关的故事</p>
                    <p>请尝试其他关键词或<a href="javascript:void(0)" onclick="clearSearchResultsHandler()">查看所有故事</a></p>
                </div>
            `;
        }

        // 显示加载状态
        function showLoading() {
            storyGrid.innerHTML = `
                <div class="loading-spinner">
                    <i class="fa fa-spinner"></i>
                    <p>搜索中...</p>
                </div>
            `;
        }

        // 隐藏加载状态
        function hideLoading() {
            const loadingSpinner = document.querySelector('.loading-spinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
        }

        // 显示错误
        function showError(message) {
            storyGrid.innerHTML = `
                <div class="no-results">
                    <i class="fa fa-exclamation-triangle"></i>
                    <h3>搜索出错</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        // 清除搜索结果
        function clearSearchResultsHandler() {
            searchInput.value = '';
            searchResults.style.display = 'none';
            clearSearch.style.display = 'none';

            // 重新加载原始故事列表
            window.location.reload();
        }

        // 事件监听器
        searchBtn.addEventListener('click', performSearch);

        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // 输入防抖
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query) {
                clearSearch.style.display = 'block';
                searchTimeout = setTimeout(performSearch, 500);
            } else {
                clearSearch.style.display = 'none';
                if (searchResults.style.display === 'block') {
                    clearSearchResultsHandler();
                }
            }
        });

        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            this.style.display = 'none';
            clearSearchResultsHandler();
        });

        clearSearchResults.addEventListener('click', clearSearchResultsHandler);

        // 全局函数，供无结果状态中的链接调用
        window.clearSearchResultsHandler = clearSearchResultsHandler;
    }

    // 添加统计信息显示
    function displayStatistics() {
        const totalStories = currentStories.length;
        const totalLikes = currentStories.reduce((sum, story) => sum + story.currentLikes, 0);
        const avgLikes = totalStories > 0 ? (totalLikes / totalStories).toFixed(1) : 0;

        // 创建统计信息栏
        const statsContainer = document.createElement('div');
        statsContainer.className = 'stats-container';
        statsContainer.innerHTML = `
            <div class="stat-item">
                <i class="fa fa-book"></i>
                <span>故事总数: ${totalStories}</span>
            </div>
            <div class="stat-item">
                <i class="fa fa-heart"></i>
                <span>总点赞数: ${totalLikes}</span>
            </div>
            <div class="stat-item">
                <i class="fa fa-star"></i>
                <span>平均点赞: ${avgLikes}</span>
            </div>
        `;

        // 插入到筛选容器后面
        const filterContainer = document.querySelector('.filter-container');
        if (filterContainer && totalStories > 0) {
            filterContainer.parentNode.insertBefore(statsContainer, filterContainer.nextSibling);
        }
    }

    // 页面卸载时清理定时器
    window.addEventListener('beforeunload', function() {
        if (likeUpdateInterval) {
            clearInterval(likeUpdateInterval);
        }
    });
</script>
{% endblock %}