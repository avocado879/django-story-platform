{% extends 'base.html' %}
{% load static %}

{% block title %}故事库 - 故事会{% endblock %}

{% block extra_css %}
<style>
    /* 主内容容器 */
    .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    /* 筛选栏 */
    .filter-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .filter-select {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        font-size: 1rem;
        color: #6d4c41;
        font-family: inherit;
    }

    /* 故事网格布局 */
    .story-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }

    /* 故事卡片*/
    .story-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(109, 76, 65, 0.05);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .story-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(109, 76, 65, 0.1);
    }
    .story-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 10px 10px 0 0;
    }
    .story-info {
        padding: 1.5rem;
    }
    .story-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
        color: #888;
    }
    .story-category {
        background-color: #8b5a2b10; /* 浅棕背景 */
        color: #8b5a2b; /* 棕色调分类标签 */
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        font-size: 0.7rem;
    }
    .story-title {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        transition: color 0.3s;
        color: #6d4c41;
    }
    .story-card:hover .story-title {
        color: #8b5a2b; /* hover时标题变色 */
    }
    .story-title a {
        text-decoration: none;
        color: inherit;
    }
    .story-excerpt {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: -webkit-box;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .story-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #888;
    }
    .story-stats span {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    /* 空状态提示 */
    .empty-state {
        text-align: center;
        padding: 5rem 0;
        color: #888;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #ddd;
    }
    .empty-state a {
        color: #8b5a2b;
        text-decoration: none;
        font-weight: 500;
    }
    .empty-state a:hover {
        text-decoration: underline;
    }

    /* 响应式适配 */
    @media (max-width: 768px) {
        .story-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="filter-container">
        <select class="filter-select" id="categoryFilter">
            <option value="all">所有分类</option>
            {% for category in categories %}
                <option value="{{ category.name }}" {% if selected_category == category.name %}selected{% endif %}>
                    {{ category.name }}
                </option>
            {% endfor %}
        </select>
        
        <select class="filter-select" id="sortFilter">
            <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>最新发布</option>
            <option value="popular" {% if sort_by == 'popular' %}selected{% endif %}>最多点赞</option>
        </select>
    </div>
    
    <div class="story-grid" id="storyGrid">
        {% for story in stories %}
            <div class="story-card">
                <div class="story-img-container">
                    <img src="https://picsum.photos/id/{{ story.img_id|default:100 }}/600/400" alt="{{ story.title }}" class="story-img">
                </div>
                <div class="story-info">
                    <div class="story-meta">
                        <span class="story-category">{{ story.category.name }}</span>
                        <span>{{ story.created_at|date:"Y-m-d" }}</span>
                    </div>
                    <h3 class="story-title">
{#                        <a href="{% url 'stories:story_detail' story.id %}">{{ story.title }}</a>#}
                    </h3>
                    <p class="story-excerpt">{{ story.content|truncatechars:100 }}</p>
                    <div class="story-stats">
                        <span><i class="fa fa-heart"></i> {{ story.likes }}</span>
                        <span><i class="fa fa-clock-o"></i> {{ story.read_time }} 分钟阅读</span>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="empty-state" id="emptyState">
                <i class="fa fa-book"></i>
                <h3>还没有故事</h3>
                <p>快去<a href="{% url 'stories:generate_story' %}">生成</a>你的第一个奇幻故事吧！</p>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 筛选和排序功能
    document.addEventListener('DOMContentLoaded', function() {
        const categoryFilter = document.getElementById('categoryFilter');
        const sortFilter = document.getElementById('sortFilter');
        
        // 当筛选条件改变时，提交表单或重定向到筛选后的页面
        function applyFilters() {
            const category = categoryFilter.value;
            const sortBy = sortFilter.value;
            
            // 构建新的URL
            let url = '{% url "stories:stories" %}?';
            
            if (category !== 'all') {
                url += `category=${category}&`;
            }
            
            if (sortBy !== 'newest') {
                url += `sort=${sortBy}&`;
            }
            
            // 移除末尾的&或?
            if (url.endsWith('&') || url.endsWith('?')) {
                url = url.slice(0, -1);
            }
            
            // 跳转到筛选后的页面
            window.location.href = url;
        }
        
        // 绑定筛选器变更事件
        categoryFilter.addEventListener('change', applyFilters);
        sortFilter.addEventListener('change', applyFilters);
    });
</script>
{% endblock %}